using System.Text.Json;
using ComputerEquipmentMS.DataAccess.Entities;
using ComputerEquipmentMS.DataAccess.Entities.Auxiliary;
using ComputerEquipmentMS.Models.Domain;
using static ComputerEquipmentMS.Constants.DbTableNames;

namespace ComputerEquipmentMS.DataAccess;

public class CustomersNpgsqlRepository : AbstractNpgsqlRepository<Customer, CustomerEntity, int>
{
    public CustomersNpgsqlRepository(IDbConnectionString connectionString, string tableName = CustomersTableName)
        : base(connectionString, tableName, DynamicToObjectMapper.MapDynamicToCustomer)
    {
    }

    /// <inheritdoc/>
    protected override string ConstructAndReturnAddQueryString(CustomerEntity customer)
    {
        var serializedContacts = SerializeContacts(customer.Contacts);
        
        var addQueryString = 
            $"""
                select * from create_customer('{customer.Name}', {serializedContacts}, '{customer.RegistrationDate:yyyy-MM-dd}'::date);
            """;

        return addQueryString;
    }

    /// <inheritdoc/>
    protected override string ConstructAndReturnEditQueryString(CustomerEntity customer)
    {
        var serializedContacts = SerializeContacts(customer.Contacts);
        
        var updateQueryString = 
            $"""
                update {TableName}
                set name = '{customer.Name}',
                    contacts = {serializedContacts}::jsonb,
                    registration_date = '{customer.RegistrationDate:yyyy-MM-dd}'::date
                where id = {customer.Id}
            """;

        return updateQueryString;
    }



    private static string SerializeContacts(ContactsEntity? contacts)
    {
        /*
         * The reason for explicit return of null is 'null' generated by serializer
         * will be interpreted by the database as null json-object, but we need null
         * database value 
         */
        if (contacts is null)
            return "null";

        var serializedContacts = $"'{JsonSerializer.Serialize(contacts)}'";
        return serializedContacts;
    }
}
